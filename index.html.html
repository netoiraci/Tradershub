  -- SQL para a Versão Masterpiece da Comunidade TradersHub

  -- 1. Habilita a extensão pgcrypto se ainda não estiver habilitada (necessária para o Supabase Storage).
  CREATE EXTENSION IF NOT EXISTS "pgcrypto";

  -- 2. Garante que a tabela de perfis tenha as colunas necessárias.
  ALTER TABLE public.profiles
  ADD COLUMN IF NOT EXISTS bio TEXT,
  ADD COLUMN IF NOT EXISTS xp INTEGER DEFAULT 0 NOT NULL,
  ADD COLUMN IF NOT EXISTS level INTEGER DEFAULT 1 NOT NULL,
  ADD COLUMN IF NOT EXISTS avatar_url TEXT;

  -- 3. Modifica a tabela de mensagens para suportar canais e anexos (estilo Discord).
  ALTER TABLE public.messages
  ADD COLUMN IF NOT EXISTS channel TEXT DEFAULT 'geral' NOT NULL,
  ADD COLUMN IF NOT EXISTS attachment_url TEXT,
  ADD COLUMN IF NOT EXISTS attachment_type TEXT; -- 'image', 'file', etc.

  -- 4. Cria a função de gamificação para adicionar XP a um usuário.
  -- Esta função será chamada pela aplicação sempre que um usuário realizar uma ação.
  CREATE OR REPLACE FUNCTION award_xp(user_id_input UUID, xp_to_add INT)
  RETURNS void
  LANGUAGE plpgsql
  AS $$
  DECLARE
    new_xp INT;
    new_level INT;
  BEGIN
    -- Adiciona o XP ao perfil do usuário.
    UPDATE public.profiles
    SET xp = xp + xp_to_add
    WHERE id = user_id_input
    RETURNING xp INTO new_xp;

    -- Calcula o novo nível (ex: 100 XP por nível).
    new_level := floor(new_xp / 100) + 1;

    -- Atualiza o nível se ele mudou.
    UPDATE public.profiles
    SET level = new_level
    WHERE id = user_id_input AND level <> new_level;
  END;
  $$;

  -- 5. Configura o Supabase Storage para avatares e anexos do chat.
  -- Cria os "buckets" (pastas de armazenamento).
  INSERT INTO storage.buckets (id, name, public)
  VALUES ('avatars', 'avatars', true)
  ON CONFLICT (id) DO NOTHING;

  INSERT INTO storage.buckets (id, name, public)
  VALUES ('attachments', 'attachments', true)
  ON CONFLICT (id) DO NOTHING;

  -- 6. Define as Políticas de Segurança para o Storage.
  -- Permite que usuários logados vejam todos os avatares e anexos.
  DROP POLICY IF EXISTS "Allow public read access" ON storage.objects;
  CREATE POLICY "Allow public read access" ON storage.objects FOR SELECT USING (true);

  -- Permite que um usuário logado envie seu próprio avatar.
  DROP POLICY IF EXISTS "Allow authenticated user to upload avatar" ON storage.objects;
  CREATE POLICY "Allow authenticated user to upload avatar" ON storage.objects FOR INSERT
  WITH CHECK (bucket_id = 'avatars' AND auth.uid() = (storage.foldername(name))[1]::uuid);

  -- Permite que um usuário logado envie anexos no chat.
  DROP POLICY IF EXISTS "Allow authenticated user to upload attachments" ON storage.objects;
  CREATE POLICY "Allow authenticated user to upload attachments" ON storage.objects FOR INSERT
  WITH CHECK (bucket_id = 'attachments' AND auth.uid() IS NOT NULL);

  -- Permite que um usuário atualize seu próprio avatar.
  DROP POLICY IF EXISTS "Allow user to update their own avatar" ON storage.objects;
  CREATE POLICY "Allow user to update their own avatar" ON storage.objects FOR UPDATE
  USING (auth.uid() = (storage.foldername(name))[1]::uuid);
